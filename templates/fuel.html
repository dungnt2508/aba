{% extends "base.html" %}

{% block title %}T·ªïng h·ª£p ƒë·ªï d·∫ßu - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="fuel-page">
    <div class="page-header">
        <h2>üìä T·ªïng h·ª£p ƒë·ªï d·∫ßu</h2>
        <p>Qu·∫£n l√Ω l∆∞·ª£ng d·∫ßu theo th√°ng cho t·∫•t c·∫£ xe</p>
    </div>

    <!-- B·ªô l·ªçc / Th√¥ng tin t·ªïng -->
    <div class="filter-section">
        <div class="card">
            <h3>üîç B·ªô l·ªçc / Th√¥ng tin t·ªïng</h3>
            <form method="GET" action="/fuel" class="filter-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="from_date">üìÖ T·ª´ ng√†y:</label>
                        <input type="date" id="from_date" name="from_date" value="{{ from_date or '' }}" 
                               title="Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu ƒë·ªÉ l·ªçc d·ªØ li·ªáu">
                    </div>
                    <div class="filter-group">
                        <label for="to_date">üìÖ ƒê·∫øn ng√†y:</label>
                        <input type="date" id="to_date" name="to_date" value="{{ to_date or '' }}"
                               title="Ch·ªçn ng√†y k·∫øt th√∫c ƒë·ªÉ l·ªçc d·ªØ li·ªáu">
                    </div>
                    <div class="filter-group">
                        <button type="submit" class="btn btn-primary">üîç L·ªçc d·ªØ li·ªáu</button>
                        <a href="/fuel" class="btn btn-secondary">üìã Xem t·∫•t c·∫£</a>
                    </div>
                </div>
                <div class="filter-info">
                    <small>üí° <strong>H∆∞·ªõng d·∫´n:</strong> Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem v√† xu·∫•t b√°o c√°o ƒë·ªï d·∫ßu theo t·ª´ng giai ƒëo·∫°n c·ª• th·ªÉ.</small>
                </div>
            </form>
            
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">T·ªïng s·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï:</span>
                    <span class="stat-value">{{ "%.3f"|format(total_liters_pumped) }} l√≠t</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">T·ªïng s·ªë b·∫£n ghi:</span>
                    <span class="stat-value">{{ total_records }} b·∫£n ghi</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Form th√™m b·∫£n ghi m·ªõi -->
    <div class="add-section">
        <div class="card">
            <h3>‚ûï Th√™m b·∫£n ghi ƒë·ªï d·∫ßu m·ªõi</h3>
            <form method="POST" action="/fuel/add" class="fuel-form">
                <input type="hidden" name="from_date" value="{{ from_date or '' }}">
                <input type="hidden" name="to_date" value="{{ to_date or '' }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Ng√†y ƒë·ªï d·∫ßu:</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="fuel_type">Lo·∫°i d·∫ßu:</label>
                        <select id="fuel_type" name="fuel_type">
                            <option value="D·∫ßu DO 0,05S-II" selected>D·∫ßu DO 0,05S-II</option>
                            <!-- C√≥ th·ªÉ th√™m c√°c lo·∫°i d·∫ßu kh√°c sau n√†y -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="license_plate">Bi·ªÉn s·ªë xe:</label>
                        <select id="license_plate" name="license_plate" required>
                            <option value="">-- Ch·ªçn xe --</option>
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fuel_price_per_liter">Gi√° xƒÉng d·∫ßu h√¥m nay (ƒë·ªìng/l√≠t):</label>
                        <input type="number" id="fuel_price_per_liter" name="fuel_price_per_liter" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="liters_pumped">S·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï:</label>
                        <input type="number" id="liters_pumped" name="liters_pumped" step="0.001" min="0" placeholder="0.000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cost_pumped">S·ªë ti·ªÅn d·∫ßu ƒë√£ ƒë·ªï (VNƒê):</label>
                        <input type="number" id="cost_pumped" name="cost_pumped" step="0.01" min="0" placeholder="0.00" readonly>
                        <small class="form-help">T·ª± ƒë·ªông t√≠nh: Gi√° xƒÉng d·∫ßu √ó S·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="notes">Ghi ch√∫:</label>
                        <textarea id="notes" name="notes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Th√™m b·∫£n ghi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt t·ª´ng xe -->
    <div class="data-section">
        <div class="card">
            <div class="section-header">
                <h3>üìã B·∫£ng chi ti·∫øt t·ª´ng xe</h3>
                <div class="export-actions">
                    <a href="/fuel/download-template" 
                       class="btn btn-info"
                       title="T·∫£i m·∫´u Excel ƒë·ªÉ import d·ªØ li·ªáu">
                        üì• T·∫£i m·∫´u
                    </a>
                    <button type="button" class="btn btn-warning" onclick="document.getElementById('importFile').click()"
                            title="Import d·ªØ li·ªáu t·ª´ file Excel">
                        üì§ Import d·ªØ li·ªáu
                    </button>
                    <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importExcel()">
                    <a href="/fuel-report/export-excel?from_date={{ from_date or '' }}&to_date={{ to_date or '' }}" 
                       class="btn btn-success"
                       title="Xu·∫•t Excel theo d·ªØ li·ªáu ƒë√£ l·ªçc">
                        üìä Xu·∫•t Excel
                    </a>
                </div>
            </div>
            
            {% if from_date and to_date %}
            <div class="filter-status">
                <p><strong>üìÖ ƒêang hi·ªÉn th·ªã:</strong> T·ª´ ng√†y {{ from_date }} ƒë·∫øn ng√†y {{ to_date }}</p>
            </div>
            {% elif from_date %}
            <div class="filter-status">
                <p><strong>üìÖ ƒêang hi·ªÉn th·ªã:</strong> T·ª´ ng√†y {{ from_date }}</p>
            </div>
            {% elif to_date %}
            <div class="filter-status">
                <p><strong>üìÖ ƒêang hi·ªÉn th·ªã:</strong> ƒê·∫øn ng√†y {{ to_date }}</p>
            </div>
            {% else %}
            <div class="filter-status">
                <p><strong>üìÖ ƒêang hi·ªÉn th·ªã:</strong> Th√°ng hi·ªán t·∫°i</p>
            </div>
            {% endif %}
            
            {% if fuel_records %}
            <div class="table-responsive">
                <table class="fuel-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ng√†y ƒë·ªï</th>
                            <th>Lo·∫°i d·∫ßu</th>
                            <th>Bi·ªÉn s·ªë xe</th>
                            <th>Gi√° xƒÉng d·∫ßu (ƒë·ªìng/l√≠t)</th>
                            <th>S·ªë l√≠t ƒë√£ ƒë·ªï</th>
                            <th>S·ªë ti·ªÅn ƒë√£ ƒë·ªï</th>
                            <th>Ghi ch√∫</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in fuel_records %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ record.fuel_type }}</td>
                            <td><strong>{{ record.license_plate }}</strong></td>
                            <td class="number">{{ "{:,.2f}".format(record.fuel_price_per_liter) }}</td>
                            <td class="number">{{ "%.3f"|format(record.liters_pumped) }}</td>
                            <td class="number">{{ "{:,.0f}".format(record.cost_pumped) }}</td>
                            <td class="notes">{{ record.notes or '' }}</td>
                            <td class="actions">
                                <a href="/fuel/edit/{{ record.id }}" class="btn btn-sm btn-warning">S·ª≠a</a>
                                <form method="POST" action="/fuel/delete/{{ record.id }}" style="display: inline;" 
                                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?')">
                                    <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td colspan="4"><strong>T·ªîNG C·ªòNG</strong></td>
                            <td class="number"><strong>-</strong></td>
                            <td class="number"><strong>{{ "%.3f"|format(fuel_records | sum(attribute='liters_pumped')) }}</strong></td>
                            <td class="number"><strong>{{ "{:,.0f}".format(fuel_records | sum(attribute='cost_pumped')) }}</strong></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Th√¥ng tin h∆∞·ªõng d·∫´n -->
    <div class="info-section">
        <div class="card">
            <h3>‚ÑπÔ∏è H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <div class="guide-sections">
                <div class="guide-section">
                    <h4>üîç B·ªô l·ªçc v√† xu·∫•t b√°o c√°o</h4>
                    <ul>
                        <li><strong>L·ªçc theo ng√†y:</strong> Ch·ªçn "T·ª´ ng√†y" v√† "ƒê·∫øn ng√†y" ƒë·ªÉ xem d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian c·ª• th·ªÉ</li>
                        <li><strong>T·∫£i m·∫´u:</strong> Nh·∫•n "T·∫£i m·∫´u" ƒë·ªÉ t·∫£i file Excel m·∫´u ƒë·ªÉ import d·ªØ li·ªáu</li>
                        <li><strong>Import d·ªØ li·ªáu:</strong> Nh·∫•n "Import d·ªØ li·ªáu" ƒë·ªÉ upload file Excel theo ƒë√∫ng m·∫´u</li>
                        <li><strong>Xu·∫•t Excel:</strong> N√∫t "Xu·∫•t Excel" s·∫Ω xu·∫•t ƒë√∫ng d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã tr√™n b·∫£ng (ƒë√£ √°p d·ª•ng b·ªô l·ªçc)</li>
                        <li><strong>Xem t·∫•t c·∫£:</strong> Nh·∫•n "Xem t·∫•t c·∫£" ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu th√°ng hi·ªán t·∫°i</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h4>üì§ Import d·ªØ li·ªáu Excel</h4>
                    <ul>
                        <li><strong>ƒê·ªãnh d·∫°ng file:</strong> Ch·ªâ ch·∫•p nh·∫≠n .xlsx ho·∫∑c .xls</li>
                        <li><strong>Th·ª© t·ª± c·ªôt:</strong> STT | Ng√†y ƒë·ªï d·∫ßu (dd/mm/yyyy) | Bi·ªÉn s·ªë xe | S·ªë l∆∞·ª£ng d·∫ßu ƒë·ªï | ƒê∆°n gi√° | Th√†nh ti·ªÅn</li>
                        <li><strong>Bi·ªÉn s·ªë xe:</strong> Ph·∫£i kh·ªõp v·ªõi danh s√°ch xe trong h·ªá th·ªëng</li>
                        <li><strong>S·ªë l∆∞·ª£ng d·∫ßu:</strong> Cho ph√©p 3 ch·ªØ s·ªë th·∫≠p ph√¢n (v√≠ d·ª•: 50.000)</li>
                        <li><strong>Th√†nh ti·ªÅn:</strong> C√≥ th·ªÉ ƒë·ªÉ tr·ªëng, h·ªá th·ªëng s·∫Ω t·ª± t√≠nh</li>
                        <li><strong>Validation:</strong> H·ªá th·ªëng ki·ªÉm tra v√† b√°o l·ªói chi ti·∫øt cho t·ª´ng d√≤ng</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h4>üí∞ T√≠nh to√°n chi ph√≠</h4>
                    <ul>
                        <li><strong>S·ªë ti·ªÅn d·∫ßu ƒë√£ ƒë·ªï</strong> = Gi√° xƒÉng d·∫ßu h√¥m nay √ó S·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï (l√†m tr√≤n ƒë·∫øn ƒë·ªìng)</li>
                        <li>H·ªá th·ªëng t·ª± ƒë·ªông t√≠nh to√°n s·ªë ti·ªÅn d·∫ßu ƒë√£ ƒë·ªï khi b·∫°n nh·∫≠p gi√° xƒÉng d·∫ßu v√† s·ªë l√≠t</li>
                        <li>S·ªë l√≠t d·∫ßu c√≥ th·ªÉ nh·∫≠p ch√≠nh x√°c ƒë·∫øn 3 ch·ªØ s·ªë th·∫≠p ph√¢n (v√≠ d·ª•: 66.428 l√≠t)</li>
                        <li>Gi√° xƒÉng d·∫ßu c√≥ th·ªÉ nh·∫≠p ch√≠nh x√°c ƒë·∫øn t·ª´ng ƒë∆°n v·ªã (v√≠ d·ª•: 19,020 ƒë·ªìng/l√≠t)</li>
                        <li>S·ªë ti·ªÅn ƒë∆∞·ª£c l√†m tr√≤n ƒë·∫øn ƒë∆°n v·ªã ƒë·ªìng ƒë·ªÉ d·ªÖ h·∫°ch to√°n</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal hi·ªÉn th·ªã chi ti·∫øt l·ªói import -->
<div id="importErrorModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ö†Ô∏è Chi ti·∫øt l·ªói Import</h3>
            <span class="close" onclick="closeImportErrorModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="importSummary" class="import-summary"></div>
            <div id="importErrors" class="import-errors"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="closeImportErrorModal()">ƒê√≥ng</button>
            <button type="button" class="btn btn-info" onclick="downloadErrorLog()">üì• T·∫£i log l·ªói</button>
        </div>
    </div>
</div>

<script>
// Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});

// T√≠nh to√°n t·ª± ƒë·ªông khi nh·∫≠p d·ªØ li·ªáu
document.addEventListener('input', function(e) {
    if (e.target.id === 'fuel_price_per_liter' || e.target.id === 'liters_pumped') {
        const fuelPrice = parseFloat(document.getElementById('fuel_price_per_liter').value) || 0;
        const litersPumped = parseFloat(document.getElementById('liters_pumped').value) || 0;
        const costPumped = fuelPrice * litersPumped;
        
        const costPumpedInput = document.getElementById('cost_pumped');
        if (costPumpedInput) {
            // L√†m tr√≤n ƒë·∫øn ƒë∆°n v·ªã ƒë·ªìng (0 ch·ªØ s·ªë th·∫≠p ph√¢n)
            costPumpedInput.value = Math.round(costPumped).toFixed(0);
        }
    }
});

// X·ª≠ l√Ω import Excel
function importExcel() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        return;
    }
    
    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
    const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel' // .xls
    ];
    
    if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
        alert('‚ùå Ch·ªâ ch·∫•p nh·∫≠n file Excel (.xlsx ho·∫∑c .xls)');
        fileInput.value = '';
        return;
    }
    
    // Hi·ªÉn th·ªã loading
    const importBtn = document.querySelector('button[onclick*="importFile"]');
    const originalText = importBtn.innerHTML;
    importBtn.innerHTML = '‚è≥ ƒêang x·ª≠ l√Ω...';
    importBtn.disabled = true;
    
    // T·∫°o FormData ƒë·ªÉ upload
    const formData = new FormData();
    formData.append('file', file);
    
    // G·ª≠i request
    fetch('/fuel/import-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.errors && data.errors.length > 0) {
                // Hi·ªÉn th·ªã modal v·ªõi chi ti·∫øt l·ªói
                showImportErrorModal(data);
            } else {
                // Kh√¥ng c√≥ l·ªói, hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng ƒë∆°n gi·∫£n
                alert(`‚úÖ Import th√†nh c√¥ng!\n\nüìä T·ªïng k·∫øt:\n- ƒê√£ import: ${data.imported_count} b·∫£n ghi\n- T·ª∑ l·ªá th√†nh c√¥ng: ${data.summary.success_rate}`);
                window.location.reload();
            }
        } else {
            // L·ªói h·ªá th·ªëng
            let errorMessage = `‚ùå Import th·∫•t b·∫°i!\n\nL·ªói: ${data.error}`;
            
            if (data.details) {
                errorMessage += `\nChi ti·∫øt: ${data.details}`;
            }
            
            if (data.suggestion) {
                errorMessage += `\n\nüí° G·ª£i √Ω: ${data.suggestion}`;
            }
            
            alert(errorMessage);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå C√≥ l·ªói x·∫£y ra khi import file. Vui l√≤ng th·ª≠ l·∫°i.');
    })
    .finally(() => {
        // Kh√¥i ph·ª•c n√∫t
        importBtn.innerHTML = originalText;
        importBtn.disabled = false;
        fileInput.value = '';
    });
}

// Hi·ªÉn th·ªã modal chi ti·∫øt l·ªói import
function showImportErrorModal(data) {
    const modal = document.getElementById('importErrorModal');
    const summaryDiv = document.getElementById('importSummary');
    const errorsDiv = document.getElementById('importErrors');
    
    // T·∫°o summary
    summaryDiv.innerHTML = `
        <div class="summary-card">
            <h4>üìä T·ªïng k·∫øt Import</h4>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">‚úÖ ƒê√£ import:</span>
                    <span class="stat-value success">${data.imported_count} b·∫£n ghi</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">‚ùå B·ªè qua:</span>
                    <span class="stat-value error">${data.skipped_count} b·∫£n ghi</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìà T·ª∑ l·ªá th√†nh c√¥ng:</span>
                    <span class="stat-value">${data.summary.success_rate}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üìã T·ªïng d√≤ng x·ª≠ l√Ω:</span>
                    <span class="stat-value">${data.summary.total_rows_processed} d√≤ng</span>
                </div>
            </div>
        </div>
    `;
    
    // T·∫°o danh s√°ch l·ªói
    let errorsHtml = '<div class="errors-list">';
    errorsHtml += '<h4>‚ö†Ô∏è Chi ti·∫øt l·ªói</h4>';
    
    data.errors.forEach((error, index) => {
        errorsHtml += `
            <div class="error-item">
                <div class="error-header">
                    <span class="error-row">D√≤ng ${error.row}</span>
                </div>
                <div class="error-details">
        `;
        
        error.errors.forEach(err => {
            errorsHtml += `
                <div class="error-detail">
                    <div class="error-info">
                        <span class="error-column">${err.column}</span>
                        <span class="error-message">${err.error}</span>
                    </div>
                    <div class="error-value">Gi√° tr·ªã: "${err.value}"</div>
                    <div class="error-suggestion">üí° ${err.suggestion}</div>
                </div>
            `;
        });
        
        errorsHtml += `
                </div>
            </div>
        `;
    });
    
    if (data.has_more_errors) {
        errorsHtml += `<div class="more-errors">... v√† ${data.remaining_errors} l·ªói kh√°c</div>`;
    }
    
    errorsHtml += '</div>';
    errorsDiv.innerHTML = errorsHtml;
    
    // L∆∞u data ƒë·ªÉ t·∫£i log
    window.importErrorData = data;
    
    // Hi·ªÉn th·ªã modal
    modal.style.display = 'block';
}

// ƒê√≥ng modal
function closeImportErrorModal() {
    document.getElementById('importErrorModal').style.display = 'none';
    // Reload trang ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu m·ªõi
    window.location.reload();
}

// T·∫£i log l·ªói
function downloadErrorLog() {
    if (!window.importErrorData) return;
    
    const data = window.importErrorData;
    let logContent = `B√ÅO C√ÅO L·ªñI IMPORT D·ªÆ LI·ªÜU ƒê·ªî D·∫¶U\n`;
    logContent += `Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}\n`;
    logContent += `=====================================\n\n`;
    
    logContent += `T·ªîNG K·∫æT:\n`;
    logContent += `- ƒê√£ import: ${data.imported_count} b·∫£n ghi\n`;
    logContent += `- B·ªè qua: ${data.skipped_count} b·∫£n ghi\n`;
    logContent += `- T·ª∑ l·ªá th√†nh c√¥ng: ${data.summary.success_rate}\n`;
    logContent += `- T·ªïng d√≤ng x·ª≠ l√Ω: ${data.summary.total_rows_processed} d√≤ng\n\n`;
    
    if (data.error_summary) {
        logContent += `PH√ÇN LO·∫†I L·ªñI:\n`;
        logContent += `- L·ªói validation: ${data.error_summary.validation_errors}\n`;
        logContent += `- L·ªói tr√πng l·∫∑p: ${data.error_summary.duplicate_errors}\n`;
        logContent += `- L·ªói k·ªπ thu·∫≠t: ${data.error_summary.technical_errors}\n\n`;
    }
    
    logContent += `CHI TI·∫æT L·ªñI:\n`;
    logContent += `=====================================\n`;
    
    data.errors.forEach((error, index) => {
        logContent += `\n${index + 1}. D√íNG ${error.row}:\n`;
        error.errors.forEach(err => {
            logContent += `   - C·ªôt: ${err.column}\n`;
            logContent += `   - L·ªói: ${err.error}\n`;
            logContent += `   - Gi√° tr·ªã: "${err.value}"\n`;
            logContent += `   - G·ª£i √Ω: ${err.suggestion}\n\n`;
        });
    });
    
    // T·∫°o v√† t·∫£i file
    const blob = new Blob([logContent], { type: 'text/plain;charset=utf-8' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `import_error_log_${new Date().toISOString().slice(0, 10)}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('importErrorModal');
    if (event.target === modal) {
        closeImportErrorModal();
    }
}
</script>
{% endblock %}
