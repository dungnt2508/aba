{% extends "base.html" %}

{% block title %}T·ªïng h·ª£p ƒë·ªï d·∫ßu - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="fuel-page">
    <div class="page-header">
        <h2>üìä T·ªïng h·ª£p ƒë·ªï d·∫ßu</h2>
        <p>Qu·∫£n l√Ω l∆∞·ª£ng d·∫ßu theo th√°ng cho t·∫•t c·∫£ xe</p>
    </div>

    <!-- B·ªô l·ªçc / Th√¥ng tin t·ªïng -->
    <div class="filter-section">
        <div class="card">
            <h3>üîç B·ªô l·ªçc / Th√¥ng tin t·ªïng</h3>
            <form method="GET" action="/fuel" class="filter-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="from_date">T·ª´ ng√†y:</label>
                        <input type="date" id="from_date" name="from_date" value="{{ from_date or '' }}">
                    </div>
                    <div class="filter-group">
                        <label for="to_date">ƒê·∫øn ng√†y:</label>
                        <input type="date" id="to_date" name="to_date" value="{{ to_date or '' }}">
                    </div>
                    <div class="filter-group">
                        <button type="submit" class="btn btn-primary">L·ªçc d·ªØ li·ªáu</button>
                        <a href="/fuel" class="btn btn-secondary">Xem t·∫•t c·∫£</a>
                    </div>
                </div>
            </form>
            
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">T·ªïng s·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï:</span>
                    <span class="stat-value">{{ "%.2f"|format(total_liters_pumped) }} l√≠t</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">T·ªïng s·ªë b·∫£n ghi:</span>
                    <span class="stat-value">{{ total_records }} b·∫£n ghi</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Form th√™m b·∫£n ghi m·ªõi -->
    <div class="add-section">
        <div class="card">
            <h3>‚ûï Th√™m b·∫£n ghi ƒë·ªï d·∫ßu m·ªõi</h3>
            <form method="POST" action="/fuel/add" class="fuel-form">
                <input type="hidden" name="from_date" value="{{ from_date or '' }}">
                <input type="hidden" name="to_date" value="{{ to_date or '' }}">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Ng√†y ƒë·ªï d·∫ßu:</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label for="fuel_type">Lo·∫°i d·∫ßu:</label>
                        <select id="fuel_type" name="fuel_type">
                            <option value="D·∫ßu DO 0,05S-II" selected>D·∫ßu DO 0,05S-II</option>
                            <!-- C√≥ th·ªÉ th√™m c√°c lo·∫°i d·∫ßu kh√°c sau n√†y -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="license_plate">Bi·ªÉn s·ªë xe:</label>
                        <select id="license_plate" name="license_plate" required>
                            <option value="">-- Ch·ªçn xe --</option>
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="liters_pumped">S·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï:</label>
                        <input type="number" id="liters_pumped" name="liters_pumped" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="cost_pumped">S·ªë ti·ªÅn d·∫ßu ƒë√£ ƒë·ªï (VNƒê):</label>
                        <input type="number" id="cost_pumped" name="cost_pumped" step="1000" min="0" placeholder="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="liters_allocated">S·ªë l√≠t d·∫ßu kho√°n:</label>
                        <input type="number" id="liters_allocated" name="liters_allocated" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="cost_allocated">S·ªë ti·ªÅn d·∫ßu kho√°n (VNƒê):</label>
                        <input type="number" id="cost_allocated" name="cost_allocated" step="1000" min="0" placeholder="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="notes">Ghi ch√∫:</label>
                        <textarea id="notes" name="notes" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success">Th√™m b·∫£n ghi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt t·ª´ng xe -->
    <div class="data-section">
        <div class="card">
            <h3>üìã B·∫£ng chi ti·∫øt t·ª´ng xe</h3>
            
            {% if fuel_records %}
            <div class="table-responsive">
                <table class="fuel-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ng√†y ƒë·ªï</th>
                            <th>Lo·∫°i d·∫ßu</th>
                            <th>Bi·ªÉn s·ªë xe</th>
                            <th>S·ªë l√≠t ƒë√£ ƒë·ªï</th>
                            <th>S·ªë ti·ªÅn ƒë√£ ƒë·ªï</th>
                            <th>S·ªë l√≠t kho√°n</th>
                            <th>S·ªë ti·ªÅn kho√°n</th>
                            <th>S·ªë l√≠t c√≤n d∆∞</th>
                            <th>S·ªë ti·ªÅn c√≤n d∆∞</th>
                            <th>Ghi ch√∫</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in fuel_records %}
                        <tr class="{{ 'surplus' if record.liters_remaining > 0 else 'deficit' if record.liters_remaining < 0 else '' }}">
                            <td>{{ loop.index }}</td>
                            <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ record.fuel_type }}</td>
                            <td><strong>{{ record.license_plate }}</strong></td>
                            <td class="number">{{ "%.2f"|format(record.liters_pumped) }}</td>
                            <td class="number">{{ "{:,.0f}".format(record.cost_pumped) }}</td>
                            <td class="number">{{ "%.2f"|format(record.liters_allocated) }}</td>
                            <td class="number">{{ "{:,.0f}".format(record.cost_allocated) }}</td>
                            <td class="number {{ 'positive' if record.liters_remaining > 0 else 'negative' if record.liters_remaining < 0 else '' }}">
                                {{ "%.2f"|format(record.liters_remaining) }}
                            </td>
                            <td class="number {{ 'positive' if record.cost_remaining > 0 else 'negative' if record.cost_remaining < 0 else '' }}">
                                {{ "{:,.0f}".format(record.cost_remaining) }}
                            </td>
                            <td class="notes">{{ record.notes or '' }}</td>
                            <td class="actions">
                                <a href="/fuel/edit/{{ record.id }}" class="btn btn-sm btn-warning">S·ª≠a</a>
                                <form method="POST" action="/fuel/delete/{{ record.id }}" style="display: inline;" 
                                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?')">
                                    <button type="submit" class="btn btn-sm btn-danger">X√≥a</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td colspan="4"><strong>T·ªîNG C·ªòNG</strong></td>
                            <td class="number"><strong>{{ "%.2f"|format(fuel_records | sum(attribute='liters_pumped')) }}</strong></td>
                            <td class="number"><strong>{{ "{:,.0f}".format(fuel_records | sum(attribute='cost_pumped')) }}</strong></td>
                            <td class="number"><strong>{{ "%.2f"|format(fuel_records | sum(attribute='liters_allocated')) }}</strong></td>
                            <td class="number"><strong>{{ "{:,.0f}".format(fuel_records | sum(attribute='cost_allocated')) }}</strong></td>
                            <td class="number"><strong>{{ "%.2f"|format(fuel_records | sum(attribute='liters_remaining')) }}</strong></td>
                            <td class="number"><strong>{{ "{:,.0f}".format(fuel_records | sum(attribute='cost_remaining')) }}</strong></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Th√¥ng tin h∆∞·ªõng d·∫´n -->
    <div class="info-section">
        <div class="card">
            <h3>‚ÑπÔ∏è H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
            <ul>
                <li><strong>S·ªë l√≠t d·∫ßu c√≤n d∆∞</strong> = S·ªë l√≠t d·∫ßu kho√°n - S·ªë l√≠t d·∫ßu ƒë√£ ƒë·ªï</li>
                <li><strong>S·ªë ti·ªÅn d·∫ßu c√≤n d∆∞</strong> = S·ªë ti·ªÅn d·∫ßu kho√°n - S·ªë ti·ªÅn d·∫ßu ƒë√£ ƒë·ªï</li>
                <li>M√†u <span class="positive">xanh l√°</span>: D∆∞ d·∫ßu (d∆∞∆°ng)</li>
                <li>M√†u <span class="negative">ƒë·ªè</span>: Th√¢m h·ª•t d·∫ßu (√¢m)</li>
                <li>H·ªá th·ªëng t·ª± ƒë·ªông t√≠nh to√°n c√°c gi√° tr·ªã c√≤n d∆∞ khi b·∫°n nh·∫≠p d·ªØ li·ªáu</li>
            </ul>
        </div>
    </div>
</div>

<script>
// Thi·∫øt l·∫≠p ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
});

// T√≠nh to√°n t·ª± ƒë·ªông khi nh·∫≠p d·ªØ li·ªáu
document.addEventListener('input', function(e) {
    if (e.target.id === 'liters_pumped' || e.target.id === 'liters_allocated' || 
        e.target.id === 'cost_pumped' || e.target.id === 'cost_allocated') {
        // C√≥ th·ªÉ th√™m logic t√≠nh to√°n t·ª± ƒë·ªông ·ªü ƒë√¢y n·∫øu c·∫ßn
    }
});
</script>
{% endblock %}
