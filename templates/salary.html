{% extends "base.html" %}

{% block title %}Tính lương - Hệ thống quản lý vận chuyển{% endblock %}

{% block content %}
<h2>📊 Thống kê hoạt động vận chuyển</h2>

<!-- Bộ lọc tìm kiếm -->
<div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #3498db; margin-bottom: 15px;">🔍 Bộ lọc tìm kiếm</h3>
    <form method="get" action="/salary" id="filterForm" onsubmit="return validateAndSubmit()">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <!-- Bộ lọc theo thời gian -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="from_date">Từ ngày</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date is defined %}{{ from_date }}{% endif %}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="to_date">Đến ngày</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date is defined %}{{ to_date }}{% endif %}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <!-- Bộ lọc theo tên nhân viên -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="driver_name">Tên nhân viên</label>
                <select id="driver_name" name="driver_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Tất cả nhân viên --</option>
                    {% for employee in employees %}
                    <option value="{{ employee.name }}" {% if driver_name is defined and employee.name == driver_name %}selected{% endif %}>{{ employee.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Bộ lọc theo biển số xe -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="license_plate">Biển số xe</label>
                <select id="license_plate" name="license_plate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Tất cả xe --</option>
                    {% for vehicle in vehicles %}
                    <option value="{{ vehicle.license_plate }}" {% if license_plate is defined and vehicle.license_plate == license_plate %}selected{% endif %}>{{ vehicle.license_plate }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Bộ lọc theo mã tuyến -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="route_code">Mã tuyến</label>
                <select id="route_code" name="route_code" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Tất cả tuyến --</option>
                    {% for route in routes %}
                    <option value="{{ route.route_code }}" {% if route_code is defined and route.route_code == route_code %}selected{% endif %}>{{ route.route_code }} - {{ route.route_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Nút thao tác -->
            <div style="display: flex; gap: 10px; align-items: end;">
                <button type="submit" class="btn" style="background: #3498db; padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer;">🔍 Tìm kiếm</button>
                <button type="button" onclick="clearAllFilters()" class="btn" style="background: #95a5a6; padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer;">🔄 Xóa bộ lọc</button>
            </div>
        </div>
    </form>
</div>

<!-- Bộ lọc theo tháng/năm (fallback) -->
<!-- <div style="background: rgba(231, 76, 60, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #e74c3c; margin-bottom: 15px;">📅 Hoặc chọn tháng xem thống kê</h3>
    <form method="get" action="/salary" style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="month">Tháng</label>
            <select id="month" name="month" style="width: auto; min-width: 120px;">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if i == month %}selected{% endif %}>Tháng {{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="year">Năm</label>
            <select id="year" name="year" style="width: auto; min-width: 120px;">
                {% for i in range(2020, 2030) %}
                <option value="{{ i }}" {% if i == year %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn">Xem thống kê</button>
    </form>
</div> -->

{% if from_date is defined and to_date is defined and from_date and to_date %}
<h3>📊 Thống kê lái xe từ {{ from_date }} đến {{ to_date }}</h3>
{% elif month is defined and year is defined and month and year %}
<h3>📊 Thống kê lái xe tháng {{ month }}/{{ year }}</h3>
{% else %}
<h3>📊 Thống kê lái xe (Tất cả dữ liệu)</h3>
{% endif %}

<!-- Hiển thị thông tin bộ lọc đang áp dụng -->
{% if (driver_name is defined and driver_name) or (license_plate is defined and license_plate) or (route_code is defined and route_code) %}
<div style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">🔍 Bộ lọc đang áp dụng:</h4>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        {% if driver_name is defined and driver_name %}
        <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            👤 Nhân viên: {{ driver_name }}
        </span>
        {% endif %}
        {% if license_plate is defined and license_plate %}
        <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            🚛 Xe: {{ license_plate }}
        </span>
        {% endif %}
        {% if route_code is defined and route_code %}
        <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            🛣️ Tuyến: {{ route_code }}
        </span>
        {% endif %}
    </div>
</div>
{% endif %}
{% if salary_data %}
<table class="table">
    <thead>
        <tr>
            <th>STT</th>
            <th>Tên lái xe</th>
            <th>Biển số xe</th>
            <th>Số chuyến</th>
            <th>Tổng số km</th>
            <th>Tổng tải trọng</th>
            <th>Các tuyến</th>
        </tr>
    </thead>
    <tbody>
        {% for data in salary_data %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ data.driver_name }}</strong></td>
            <td>
                <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                    {{ data.license_plate }}
                </span>
            </td>
            <td>
                <a href="/salary/driver-details-page/{{ data.driver_name }}{% if from_date and to_date %}?from_date={{ from_date }}&to_date={{ to_date }}{% endif %}" 
                   style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; text-decoration: none; display: inline-block; transition: all 0.2s;" 
                   onmouseover="this.style.background='rgba(52, 152, 219, 0.2)'; this.style.transform='scale(1.05)'" 
                   onmouseout="this.style.background='rgba(52, 152, 219, 0.1)'; this.style.transform='scale(1)'"
                   title="Click để xem chi tiết chuyến">
                    {{ data.trip_count }} chuyến
                </a>
            </td>
            <td>{{ "{:,.1f}".format(data.total_distance) }} km</td>
            <td>{{ "{:,.1f}".format(data.total_cargo) }} kg</td>
            <td>
                {% for route in data.routes %}
                    <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">
                        {{ route }}
                    </span>
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
    <!-- <tfoot style="background: rgba(52, 73, 94, 0.1); font-weight: bold;">
        <tr>
            <td colspan="3"><strong>TỔNG CỘNG</strong></td>
            <td><strong>{{ total_routes }} chuyến</strong></td>
            <td><strong>{{ "{:,.1f}".format(total_distance) }} km</strong></td>
            <td><strong>{{ "{:,.1f}".format(total_cargo) }} kg</strong></td>
            <td><strong>-</strong></td>
        </tr>
    </tfoot> -->
</table>

<!-- Chi tiết từng chuyến -->
<div style="margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">📋 Chi tiết từng chuyến</h3>
        <a href="/salary/export-excel{% if from_date and to_date %}?from_date={{ from_date }}&to_date={{ to_date }}{% endif %}{% if driver_name %}{% if from_date and to_date %}&{% else %}?{% endif %}driver_name={{ driver_name }}{% endif %}{% if license_plate %}{% if from_date and to_date or driver_name %}&{% else %}?{% endif %}license_plate={{ license_plate }}{% endif %}{% if route_code %}{% if from_date and to_date or driver_name or license_plate %}&{% else %}?{% endif %}route_code={{ route_code }}{% endif %}" 
           class="btn" 
           style="background: #27ae60; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px;"
           onmouseover="this.style.background='#229954'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'"
           onmouseout="this.style.background='#27ae60'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
           title="Xuất danh sách chi tiết chuyến ra file Excel">
            📊 Xuất Excel
        </a>
    </div>
    <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
                <tr style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                    <th style="padding: 15px; text-align: left; font-weight: 600;">STT</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Tên lái xe</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Ngày chạy</th>                    
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Biển số xe</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Mã tuyến</th>
                    <!-- <th style="padding: 15px; text-align: left; font-weight: 600;">Tên tuyến</th>
                    <th style="padding: 15px; text-align: right; font-weight: 600;">Km</th>
                    <th style="padding: 15px; text-align: right; font-weight: 600;">Tải trọng</th> -->
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Ghi chú</th>
                </tr>
            </thead>
            <tbody>
                {% for trip in trip_details %}
                <tr style="border-bottom: 1px solid #ecf0f1; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(52, 152, 219, 0.05)'" onmouseout="this.style.backgroundColor='white'">
                    <td style="padding: 15px; font-weight: 500; color: #2c3e50;">{{ loop.index }}</td>
                    <td style="padding: 15px; font-weight: 600; color: #2c3e50;">
                        <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                            👤 {{ trip.driver_name }}
                        </span>
                    </td>
                    <td style="padding: 15px; font-weight: 500; color: #2c3e50;">
                        <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                            {{ trip.date.strftime('%d/%m/%Y') }}
                        </span>
                    </td>
                    
                    <td style="padding: 15px;">
                        <span style="background: rgba(231, 76, 60, 0.1); color: #e74c3c; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: 500;">
                            {{ trip.license_plate }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: 500;">
                            {{ trip.route_code }}
                        </span>
                    </td>
                    <!-- <td style="padding: 15px; color: #2c3e50;">{{ trip.route_name }}</td> -->
                    <!-- <td style="padding: 15px; text-align: right; font-weight: 500; color: #e67e22;">
                        {{ "{:,.1f}".format(trip.distance_km) }} km
                    </td>
                    <td style="padding: 15px; text-align: right; font-weight: 500; color: #e67e22;">
                        {{ "{:,.1f}".format(trip.cargo_weight) }} kg
                    </td> -->
                    <td style="padding: 15px; color: #7f8c8d; font-style: italic;">
                        {{ trip.notes or '-' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <!-- <tfoot style="background: rgba(52, 73, 94, 0.1); font-weight: bold;">
                <tr>
                    <td colspan="6" style="padding: 15px; text-align: right;"><strong>TỔNG CỘNG</strong></td>
                    <td style="padding: 15px; text-align: right; color: #e67e22;">
                        <strong>{{ "{:,.1f}".format(total_distance) }} km</strong>
                    </td>
                    <td style="padding: 15px; text-align: right; color: #e67e22;">
                        <strong>{{ "{:,.1f}".format(total_cargo) }} kg</strong>
                    </td>
                    <td style="padding: 15px;"></td>
                </tr>
            </tfoot> -->
        </table>
    </div>
</div>

<!-- Thống kê tổng quan -->
<div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
    {% if from_date is defined and to_date is defined and from_date and to_date %}
    <h3 style="margin-bottom: 20px;">📊 Thống kê tổng quan từ {{ from_date }} đến {{ to_date }}</h3>
    {% elif month is defined and year is defined and month and year %}
    <h3 style="margin-bottom: 20px;">📊 Thống kê tổng quan tháng {{ month }}/{{ year }}</h3>
    {% else %}
    <h3 style="margin-bottom: 20px;">📊 Thống kê tổng quan (Tất cả dữ liệu)</h3>
    {% endif %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ salary_data|length }}</h4>
            <p>Lái xe</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ total_routes }}</h4>
            <p>Tổng chuyến</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ "{:,.1f}".format(total_distance) }}</h4>
            <p>Tổng km</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ "{:,.1f}".format(total_cargo) }}</h4>
            <p>Tổng tải trọng (kg)</p>
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    {% if from_date is defined and to_date is defined and from_date and to_date %}
    <h3>📅 Chưa có dữ liệu thống kê từ {{ from_date }} đến {{ to_date }}</h3>
    <p>Có thể chưa có chuyến nào được ghi nhận trong khoảng thời gian này</p>
    {% elif month is defined and year is defined and month and year %}
    <h3>📅 Chưa có dữ liệu thống kê tháng {{ month }}/{{ year }}</h3>
    <p>Có thể chưa có chuyến nào được ghi nhận trong tháng này</p>
    {% else %}
    <h3>📅 Chưa có dữ liệu thống kê</h3>
    <p>Có thể chưa có chuyến nào được ghi nhận trong hệ thống</p>
    {% endif %}
    <div style="margin-top: 20px;">
        <a href="/daily" class="btn">Ghi nhận chuyến</a>
        <a href="/employees" class="btn" style="margin-left: 10px;">Thêm nhân viên</a>
    </div>
</div>
{% endif %}

<div style="margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">💡 Thông tin thống kê:</h4>
    <div style="color: #2c3e50; line-height: 1.6;">
        <p><strong>Báo cáo thống kê hoạt động vận chuyển theo lái xe</strong></p>
        <ul style="margin-top: 10px;">
            <li><strong>Số chuyến:</strong> Tổng số chuyến vận chuyển lái xe đã thực hiện</li>
            <li><strong>Tổng số km:</strong> Tổng quãng đường thực tế đã chạy</li>
            <li><strong>Tổng tải trọng:</strong> Tổng trọng lượng hàng hóa đã vận chuyển</li>
            <li><strong>Các tuyến:</strong> Danh sách mã tuyến lái xe đã chạy</li>
        </ul>
    </div>
</div>

<script>
function validateAndSubmit() {
    // Đảm bảo form submit với tất cả giá trị hiện tại
    console.log('Form submitting with values:');
    console.log('Driver name:', document.getElementById('driver_name').value);
    console.log('License plate:', document.getElementById('license_plate').value);
    console.log('Route code:', document.getElementById('route_code').value);
    console.log('From date:', document.getElementById('from_date').value);
    console.log('To date:', document.getElementById('to_date').value);
    
    return true; // Cho phép form submit bình thường
}

function clearAllFilters() {
    // Reset tất cả các field về giá trị mặc định
    document.getElementById('from_date').value = '';
    document.getElementById('to_date').value = '';
    document.getElementById('driver_name').value = '';
    document.getElementById('license_plate').value = '';
    document.getElementById('route_code').value = '';
    
    // Submit form để reload trang với dữ liệu mặc định
    document.getElementById('filterForm').submit();
}

// Đảm bảo dropdown hiển thị đúng khi trang load
document.addEventListener('DOMContentLoaded', function() {
    // Chỉ reset các dropdown về "Tất cả" nếu thực sự không có giá trị được chọn
    // và không phải từ việc submit form
    const driverSelect = document.getElementById('driver_name');
    const licenseSelect = document.getElementById('license_plate');
    const routeSelect = document.getElementById('route_code');
    
    // Kiểm tra xem có phải là lần đầu load trang hay không
    // Chỉ reset nếu không có giá trị nào được chọn từ server
    const urlParams = new URLSearchParams(window.location.search);
    
    // Chỉ reset nếu không có tham số từ URL (nghĩa là lần đầu load trang)
    if (!urlParams.has('driver_name') && !urlParams.has('license_plate') && !urlParams.has('route_code')) {
        if (!driverSelect.value) {
            driverSelect.selectedIndex = 0; // Chọn option đầu tiên (Tất cả nhân viên)
        }
        
        if (!licenseSelect.value) {
            licenseSelect.selectedIndex = 0; // Chọn option đầu tiên (Tất cả xe)
        }
        
        if (!routeSelect.value) {
            routeSelect.selectedIndex = 0; // Chọn option đầu tiên (Tất cả tuyến)
        }
    }
});
</script>
{% endblock %}
