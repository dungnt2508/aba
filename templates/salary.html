{% extends "base.html" %}

{% block title %}TÃ­nh lÆ°Æ¡ng - Há»‡ thá»‘ng quáº£n lÃ½ váº­n chuyá»ƒn{% endblock %}

{% block content %}
<h2>ğŸ“Š Thá»‘ng kÃª hoáº¡t Ä‘á»™ng váº­n chuyá»ƒn</h2>

<!-- Bá»™ lá»c tÃ¬m kiáº¿m -->
<div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #3498db; margin-bottom: 15px;">ğŸ” Bá»™ lá»c tÃ¬m kiáº¿m</h3>
    <form method="get" action="/salary" id="filterForm" onsubmit="return validateAndSubmit()">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
            <!-- Bá»™ lá»c theo thá»i gian -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="from_date">Tá»« ngÃ y</label>
                <input type="date" id="from_date" name="from_date" value="{% if from_date is defined %}{{ from_date }}{% endif %}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="to_date">Äáº¿n ngÃ y</label>
                <input type="date" id="to_date" name="to_date" value="{% if to_date is defined %}{{ to_date }}{% endif %}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <!-- Bá»™ lá»c theo tÃªn nhÃ¢n viÃªn -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="driver_name">TÃªn nhÃ¢n viÃªn</label>
                <select id="driver_name" name="driver_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Táº¥t cáº£ nhÃ¢n viÃªn --</option>
                    {% for employee in employees %}
                    <option value="{{ employee.name }}" {% if driver_name is defined and employee.name == driver_name %}selected{% endif %}>{{ employee.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Bá»™ lá»c theo biá»ƒn sá»‘ xe -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="license_plate">Biá»ƒn sá»‘ xe</label>
                <select id="license_plate" name="license_plate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Táº¥t cáº£ xe --</option>
                    {% for vehicle in vehicles %}
                    <option value="{{ vehicle.license_plate }}" {% if license_plate is defined and vehicle.license_plate == license_plate %}selected{% endif %}>{{ vehicle.license_plate }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Bá»™ lá»c theo mÃ£ tuyáº¿n -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="route_code">MÃ£ tuyáº¿n</label>
                <select id="route_code" name="route_code" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Táº¥t cáº£ tuyáº¿n --</option>
                    {% for route in routes %}
                    <option value="{{ route.route_code }}" {% if route_code is defined and route.route_code == route_code %}selected{% endif %}>{{ route.route_code }} - {{ route.route_name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- NÃºt thao tÃ¡c -->
            <div style="display: flex; gap: 10px; align-items: end;">
                <button type="submit" class="btn" style="background: #3498db; padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer;">ğŸ” TÃ¬m kiáº¿m</button>
                <button type="button" onclick="clearAllFilters()" class="btn" style="background: #95a5a6; padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer;">ğŸ”„ XÃ³a bá»™ lá»c</button>
            </div>
        </div>
    </form>
</div>

<!-- Bá»™ lá»c theo thÃ¡ng/nÄƒm (fallback) -->
<!-- <div style="background: rgba(231, 76, 60, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #e74c3c; margin-bottom: 15px;">ğŸ“… Hoáº·c chá»n thÃ¡ng xem thá»‘ng kÃª</h3>
    <form method="get" action="/salary" style="display: flex; gap: 20px; align-items: end; flex-wrap: wrap;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="month">ThÃ¡ng</label>
            <select id="month" name="month" style="width: auto; min-width: 120px;">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if i == month %}selected{% endif %}>ThÃ¡ng {{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="year">NÄƒm</label>
            <select id="year" name="year" style="width: auto; min-width: 120px;">
                {% for i in range(2020, 2030) %}
                <option value="{{ i }}" {% if i == year %}selected{% endif %}>{{ i }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn">Xem thá»‘ng kÃª</button>
    </form>
</div> -->

{% if from_date is defined and to_date is defined and from_date and to_date %}
<h3>ğŸ“Š Thá»‘ng kÃª lÃ¡i xe tá»« {{ from_date }} Ä‘áº¿n {{ to_date }}</h3>
{% elif month is defined and year is defined and month and year %}
<h3>ğŸ“Š Thá»‘ng kÃª lÃ¡i xe thÃ¡ng {{ month }}/{{ year }}</h3>
{% else %}
<h3>ğŸ“Š Thá»‘ng kÃª lÃ¡i xe (Táº¥t cáº£ dá»¯ liá»‡u)</h3>
{% endif %}

<!-- Hiá»ƒn thá»‹ thÃ´ng tin bá»™ lá»c Ä‘ang Ã¡p dá»¥ng -->
{% if (driver_name is defined and driver_name) or (license_plate is defined and license_plate) or (route_code is defined and route_code) %}
<div style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">ğŸ” Bá»™ lá»c Ä‘ang Ã¡p dá»¥ng:</h4>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        {% if driver_name is defined and driver_name %}
        <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            ğŸ‘¤ NhÃ¢n viÃªn: {{ driver_name }}
        </span>
        {% endif %}
        {% if license_plate is defined and license_plate %}
        <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            ğŸš› Xe: {{ license_plate }}
        </span>
        {% endif %}
        {% if route_code is defined and route_code %}
        <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
            ğŸ›£ï¸ Tuyáº¿n: {{ route_code }}
        </span>
        {% endif %}
    </div>
</div>
{% endif %}
{% if salary_data %}
<table class="table">
    <thead>
        <tr>
            <th>STT</th>
            <th>TÃªn lÃ¡i xe</th>
            <th>Biá»ƒn sá»‘ xe</th>
            <th>Sá»‘ chuyáº¿n</th>
            <th>Tá»•ng sá»‘ km</th>
            <th>Tá»•ng táº£i trá»ng</th>
            <th>CÃ¡c tuyáº¿n</th>
        </tr>
    </thead>
    <tbody>
        {% for data in salary_data %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ data.driver_name }}</strong></td>
            <td>
                <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                    {{ data.license_plate }}
                </span>
            </td>
            <td>
                <a href="/salary/driver-details-page/{{ data.driver_name }}{% if from_date and to_date %}?from_date={{ from_date }}&to_date={{ to_date }}{% endif %}" 
                   style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; text-decoration: none; display: inline-block; transition: all 0.2s;" 
                   onmouseover="this.style.background='rgba(52, 152, 219, 0.2)'; this.style.transform='scale(1.05)'" 
                   onmouseout="this.style.background='rgba(52, 152, 219, 0.1)'; this.style.transform='scale(1)'"
                   title="Click Ä‘á»ƒ xem chi tiáº¿t chuyáº¿n">
                    {{ data.trip_count }} chuyáº¿n
                </a>
            </td>
            <td>{{ "{:,.1f}".format(data.total_distance) }} km</td>
            <td>{{ "{:,.1f}".format(data.total_cargo) }} kg</td>
            <td>
                {% for route in data.routes %}
                    <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">
                        {{ route }}
                    </span>
                {% endfor %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
    <!-- <tfoot style="background: rgba(52, 73, 94, 0.1); font-weight: bold;">
        <tr>
            <td colspan="3"><strong>Tá»”NG Cá»˜NG</strong></td>
            <td><strong>{{ total_routes }} chuyáº¿n</strong></td>
            <td><strong>{{ "{:,.1f}".format(total_distance) }} km</strong></td>
            <td><strong>{{ "{:,.1f}".format(total_cargo) }} kg</strong></td>
            <td><strong>-</strong></td>
        </tr>
    </tfoot> -->
</table>

<!-- Chi tiáº¿t tá»«ng chuyáº¿n -->
<div style="margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">ğŸ“‹ Chi tiáº¿t tá»«ng chuyáº¿n</h3>
        <a href="/salary/export-excel{% if from_date and to_date %}?from_date={{ from_date }}&to_date={{ to_date }}{% endif %}{% if driver_name %}{% if from_date and to_date %}&{% else %}?{% endif %}driver_name={{ driver_name }}{% endif %}{% if license_plate %}{% if from_date and to_date or driver_name %}&{% else %}?{% endif %}license_plate={{ license_plate }}{% endif %}{% if route_code %}{% if from_date and to_date or driver_name or license_plate %}&{% else %}?{% endif %}route_code={{ route_code }}{% endif %}" 
           class="btn" 
           style="background: #27ae60; color: white; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px;"
           onmouseover="this.style.background='#229954'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'"
           onmouseout="this.style.background='#27ae60'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
           title="Xuáº¥t danh sÃ¡ch chi tiáº¿t chuyáº¿n ra file Excel">
            ğŸ“Š Xuáº¥t Excel
        </a>
    </div>
    <div style="background: rgba(255, 255, 255, 0.9); padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
            <thead>
                <tr style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                    <th style="padding: 15px; text-align: left; font-weight: 600;">STT</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">TÃªn lÃ¡i xe</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">NgÃ y cháº¡y</th>                    
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Biá»ƒn sá»‘ xe</th>
                    <th style="padding: 15px; text-align: left; font-weight: 600;">MÃ£ tuyáº¿n</th>
                    <!-- <th style="padding: 15px; text-align: left; font-weight: 600;">TÃªn tuyáº¿n</th>
                    <th style="padding: 15px; text-align: right; font-weight: 600;">Km</th>
                    <th style="padding: 15px; text-align: right; font-weight: 600;">Táº£i trá»ng</th> -->
                    <th style="padding: 15px; text-align: left; font-weight: 600;">Ghi chÃº</th>
                </tr>
            </thead>
            <tbody>
                {% for trip in trip_details %}
                <tr style="border-bottom: 1px solid #ecf0f1; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(52, 152, 219, 0.05)'" onmouseout="this.style.backgroundColor='white'">
                    <td style="padding: 15px; font-weight: 500; color: #2c3e50;">{{ loop.index }}</td>
                    <td style="padding: 15px; font-weight: 600; color: #2c3e50;">
                        <span style="background: rgba(155, 89, 182, 0.1); color: #9b59b6; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                            ğŸ‘¤ {{ trip.driver_name }}
                        </span>
                    </td>
                    <td style="padding: 15px; font-weight: 500; color: #2c3e50;">
                        <span style="background: rgba(52, 152, 219, 0.1); color: #3498db; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                            {{ trip.date.strftime('%d/%m/%Y') }}
                        </span>
                    </td>
                    
                    <td style="padding: 15px;">
                        <span style="background: rgba(231, 76, 60, 0.1); color: #e74c3c; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: 500;">
                            {{ trip.license_plate }}
                        </span>
                    </td>
                    <td style="padding: 15px;">
                        <span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; font-weight: 500;">
                            {{ trip.route_code }}
                        </span>
                    </td>
                    <!-- <td style="padding: 15px; color: #2c3e50;">{{ trip.route_name }}</td> -->
                    <!-- <td style="padding: 15px; text-align: right; font-weight: 500; color: #e67e22;">
                        {{ "{:,.1f}".format(trip.distance_km) }} km
                    </td>
                    <td style="padding: 15px; text-align: right; font-weight: 500; color: #e67e22;">
                        {{ "{:,.1f}".format(trip.cargo_weight) }} kg
                    </td> -->
                    <td style="padding: 15px; color: #7f8c8d; font-style: italic;">
                        {{ trip.notes or '-' }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <!-- <tfoot style="background: rgba(52, 73, 94, 0.1); font-weight: bold;">
                <tr>
                    <td colspan="6" style="padding: 15px; text-align: right;"><strong>Tá»”NG Cá»˜NG</strong></td>
                    <td style="padding: 15px; text-align: right; color: #e67e22;">
                        <strong>{{ "{:,.1f}".format(total_distance) }} km</strong>
                    </td>
                    <td style="padding: 15px; text-align: right; color: #e67e22;">
                        <strong>{{ "{:,.1f}".format(total_cargo) }} kg</strong>
                    </td>
                    <td style="padding: 15px;"></td>
                </tr>
            </tfoot> -->
        </table>
    </div>
</div>

<!-- Thá»‘ng kÃª tá»•ng quan -->
<div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
    {% if from_date is defined and to_date is defined and from_date and to_date %}
    <h3 style="margin-bottom: 20px;">ğŸ“Š Thá»‘ng kÃª tá»•ng quan tá»« {{ from_date }} Ä‘áº¿n {{ to_date }}</h3>
    {% elif month is defined and year is defined and month and year %}
    <h3 style="margin-bottom: 20px;">ğŸ“Š Thá»‘ng kÃª tá»•ng quan thÃ¡ng {{ month }}/{{ year }}</h3>
    {% else %}
    <h3 style="margin-bottom: 20px;">ğŸ“Š Thá»‘ng kÃª tá»•ng quan (Táº¥t cáº£ dá»¯ liá»‡u)</h3>
    {% endif %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ salary_data|length }}</h4>
            <p>LÃ¡i xe</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ total_routes }}</h4>
            <p>Tá»•ng chuyáº¿n</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ "{:,.1f}".format(total_distance) }}</h4>
            <p>Tá»•ng km</p>
        </div>
        <div style="text-align: center;">
            <h4 style="font-size: 2em; margin-bottom: 5px;">{{ "{:,.1f}".format(total_cargo) }}</h4>
            <p>Tá»•ng táº£i trá»ng (kg)</p>
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    {% if from_date is defined and to_date is defined and from_date and to_date %}
    <h3>ğŸ“… ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª tá»« {{ from_date }} Ä‘áº¿n {{ to_date }}</h3>
    <p>CÃ³ thá»ƒ chÆ°a cÃ³ chuyáº¿n nÃ o Ä‘Æ°á»£c ghi nháº­n trong khoáº£ng thá»i gian nÃ y</p>
    {% elif month is defined and year is defined and month and year %}
    <h3>ğŸ“… ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª thÃ¡ng {{ month }}/{{ year }}</h3>
    <p>CÃ³ thá»ƒ chÆ°a cÃ³ chuyáº¿n nÃ o Ä‘Æ°á»£c ghi nháº­n trong thÃ¡ng nÃ y</p>
    {% else %}
    <h3>ğŸ“… ChÆ°a cÃ³ dá»¯ liá»‡u thá»‘ng kÃª</h3>
    <p>CÃ³ thá»ƒ chÆ°a cÃ³ chuyáº¿n nÃ o Ä‘Æ°á»£c ghi nháº­n trong há»‡ thá»‘ng</p>
    {% endif %}
    <div style="margin-top: 20px;">
        <a href="/daily" class="btn">Ghi nháº­n chuyáº¿n</a>
        <a href="/employees" class="btn" style="margin-left: 10px;">ThÃªm nhÃ¢n viÃªn</a>
    </div>
</div>
{% endif %}

<div style="margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">ğŸ’¡ ThÃ´ng tin thá»‘ng kÃª:</h4>
    <div style="color: #2c3e50; line-height: 1.6;">
        <p><strong>BÃ¡o cÃ¡o thá»‘ng kÃª hoáº¡t Ä‘á»™ng váº­n chuyá»ƒn theo lÃ¡i xe</strong></p>
        <ul style="margin-top: 10px;">
            <li><strong>Sá»‘ chuyáº¿n:</strong> Tá»•ng sá»‘ chuyáº¿n váº­n chuyá»ƒn lÃ¡i xe Ä‘Ã£ thá»±c hiá»‡n</li>
            <li><strong>Tá»•ng sá»‘ km:</strong> Tá»•ng quÃ£ng Ä‘Æ°á»ng thá»±c táº¿ Ä‘Ã£ cháº¡y</li>
            <li><strong>Tá»•ng táº£i trá»ng:</strong> Tá»•ng trá»ng lÆ°á»£ng hÃ ng hÃ³a Ä‘Ã£ váº­n chuyá»ƒn</li>
            <li><strong>CÃ¡c tuyáº¿n:</strong> Danh sÃ¡ch mÃ£ tuyáº¿n lÃ¡i xe Ä‘Ã£ cháº¡y</li>
        </ul>
    </div>
</div>

<script>
function validateAndSubmit() {
    // Äáº£m báº£o form submit vá»›i táº¥t cáº£ giÃ¡ trá»‹ hiá»‡n táº¡i
    console.log('Form submitting with values:');
    console.log('Driver name:', document.getElementById('driver_name').value);
    console.log('License plate:', document.getElementById('license_plate').value);
    console.log('Route code:', document.getElementById('route_code').value);
    console.log('From date:', document.getElementById('from_date').value);
    console.log('To date:', document.getElementById('to_date').value);
    
    return true; // Cho phÃ©p form submit bÃ¬nh thÆ°á»ng
}

function clearAllFilters() {
    // Reset táº¥t cáº£ cÃ¡c field vá» giÃ¡ trá»‹ máº·c Ä‘á»‹nh
    document.getElementById('from_date').value = '';
    document.getElementById('to_date').value = '';
    document.getElementById('driver_name').value = '';
    document.getElementById('license_plate').value = '';
    document.getElementById('route_code').value = '';
    
    // Submit form Ä‘á»ƒ reload trang vá»›i dá»¯ liá»‡u máº·c Ä‘á»‹nh
    document.getElementById('filterForm').submit();
}

// Äáº£m báº£o dropdown hiá»ƒn thá»‹ Ä‘Ãºng khi trang load
document.addEventListener('DOMContentLoaded', function() {
    // Chá»‰ reset cÃ¡c dropdown vá» "Táº¥t cáº£" náº¿u thá»±c sá»± khÃ´ng cÃ³ giÃ¡ trá»‹ Ä‘Æ°á»£c chá»n
    // vÃ  khÃ´ng pháº£i tá»« viá»‡c submit form
    const driverSelect = document.getElementById('driver_name');
    const licenseSelect = document.getElementById('license_plate');
    const routeSelect = document.getElementById('route_code');
    
    // Kiá»ƒm tra xem cÃ³ pháº£i lÃ  láº§n Ä‘áº§u load trang hay khÃ´ng
    // Chá»‰ reset náº¿u khÃ´ng cÃ³ giÃ¡ trá»‹ nÃ o Ä‘Æ°á»£c chá»n tá»« server
    const urlParams = new URLSearchParams(window.location.search);
    
    // Chá»‰ reset náº¿u khÃ´ng cÃ³ tham sá»‘ tá»« URL (nghÄ©a lÃ  láº§n Ä‘áº§u load trang)
    if (!urlParams.has('driver_name') && !urlParams.has('license_plate') && !urlParams.has('route_code')) {
        if (!driverSelect.value) {
            driverSelect.selectedIndex = 0; // Chá»n option Ä‘áº§u tiÃªn (Táº¥t cáº£ nhÃ¢n viÃªn)
        }
        
        if (!licenseSelect.value) {
            licenseSelect.selectedIndex = 0; // Chá»n option Ä‘áº§u tiÃªn (Táº¥t cáº£ xe)
        }
        
        if (!routeSelect.value) {
            routeSelect.selectedIndex = 0; // Chá»n option Ä‘áº§u tiÃªn (Táº¥t cáº£ tuyáº¿n)
        }
    }
});
</script>
{% endblock %}
