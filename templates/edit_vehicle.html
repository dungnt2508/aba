{% extends "base.html" %}

{% block title %}S·ª≠a xe - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>‚úèÔ∏è S·ª≠a th√¥ng tin xe</h2>

<div style="background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px; border-radius: 10px;">
    <h3 style="margin-bottom: 15px;">C·∫≠p nh·∫≠t th√¥ng tin xe</h3>
    <form method="post" action="/vehicles/edit/{{ vehicle.id }}" enctype="multipart/form-data" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="form-group">
            <label for="license_plate">Bi·ªÉn s·ªë xe *</label>
            <input type="text" id="license_plate" name="license_plate" required placeholder="VD: 50H-448.42" value="{{ vehicle.license_plate }}">
        </div>
        <div class="form-group">
            <label for="vehicle_info">Th√¥ng tin xe *</label>
            <input type="text" id="vehicle_info" name="vehicle_info" required placeholder="VD: Hino 3T" value="{{ vehicle.vehicle_info or '' }}">
        </div>
        <div class="form-group">
            <label for="capacity">T·∫£i tr·ªçng (kg) *</label>
            <input type="number" id="capacity" name="capacity" step="100" required placeholder="VD: 5000" value="{{ vehicle.capacity or '' }}">
        </div>
        <div class="form-group">
            <label for="fuel_consumption">ƒê·ªãnh m·ª©c nhi√™n li·ªáu (l/100km)</label>
            <input type="number" id="fuel_consumption" name="fuel_consumption" step="0.1" placeholder="VD: 25.5" value="{{ vehicle.fuel_consumption or '' }}">
        </div>
        <div class="form-group">
            <label for="inspection_expiry">Ng√†y h·∫øt h·∫°n ƒëƒÉng ki·ªÉm</label>
            <input type="date" id="inspection_expiry" name="inspection_expiry" value="{{ vehicle.inspection_expiry.strftime('%Y-%m-%d') if vehicle.inspection_expiry else '' }}">
        </div>
        <div class="form-group">
            <label for="inspection_documents">Upload th√™m s·ªï ƒëƒÉng ki·ªÉm</label>
            <input type="file" id="inspection_documents" name="inspection_documents" multiple accept=".pdf,.jpg,.jpeg,.png,.gif">
            <small style="color: #7f8c8d;">C√≥ th·ªÉ ch·ªçn nhi·ªÅu ·∫£nh (PDF, JPG, PNG, GIF)</small>
        </div>
        <div class="form-group">
            <label for="phu_hieu_expired_date">Ng√†y h·∫øt h·∫°n ph√π hi·ªáu v·∫≠n t·∫£i</label>
            <input type="date" id="phu_hieu_expired_date" name="phu_hieu_expired_date" value="{{ vehicle.phu_hieu_expired_date.strftime('%Y-%m-%d') if vehicle.phu_hieu_expired_date else '' }}">
        </div>
        <div class="form-group">
            <label for="phu_hieu_files">Upload th√™m ph√π hi·ªáu v·∫≠n t·∫£i</label>
            <input type="file" id="phu_hieu_files" name="phu_hieu_files" multiple accept=".pdf,.jpg,.jpeg,.png,.gif">
            <small style="color: #7f8c8d;">C√≥ th·ªÉ ch·ªçn nhi·ªÅu ·∫£nh (PDF, JPG, PNG, GIF)</small>
        </div>
        
        <!-- Hi·ªÉn th·ªã s·ªï ƒëƒÉng ki·ªÉm hi·ªán c√≥ -->
        {% if vehicle.inspection_documents %}
        <div class="form-group" style="grid-column: 1 / -1;">
            <label>S·ªï ƒëƒÉng ki·ªÉm hi·ªán c√≥:</label>
            <div id="currentDocuments" style="margin-top: 10px;">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
            </div>
        </div>
        {% endif %}
        
        <!-- Hi·ªÉn th·ªã ph√π hi·ªáu v·∫≠n t·∫£i hi·ªán c√≥ -->
        {% if vehicle.phu_hieu_files %}
        <div class="form-group" style="grid-column: 1 / -1;">
            <label>Ph√π hi·ªáu v·∫≠n t·∫£i hi·ªán c√≥:</label>
            <div id="currentPhuHieuDocuments" style="margin-top: 10px;">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
            </div>
        </div>
        {% endif %}
        
        <div class="form-group" style="display: flex; align-items: end; gap: 10px; grid-column: 1 / -1;">
            <button type="submit" class="btn btn-success">C·∫≠p nh·∫≠t</button>
            <a href="/vehicles" class="btn btn-secondary">H·ªßy</a>
        </div>
    </form>
</div>

<style>
.document-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
    background: #f8f9fa;
}

.document-item img {
    max-width: 60px;
    max-height: 60px;
    object-fit: cover;
    border-radius: 5px;
}

.document-info {
    flex: 1;
}

.document-actions {
    display: flex;
    gap: 5px;
}
</style>

<script>
// Load s·ªï ƒëƒÉng ki·ªÉm hi·ªán c√≥ khi trang load
document.addEventListener('DOMContentLoaded', function() {
    {% if vehicle.inspection_documents %}
    loadCurrentDocuments({{ vehicle.id }});
    {% endif %}
    {% if vehicle.phu_hieu_files %}
    loadCurrentPhuHieuDocuments({{ vehicle.id }});
    {% endif %}
});

async function loadCurrentDocuments(vehicleId) {
    try {
        const response = await fetch(`/vehicles/documents/${vehicleId}`);
        const data = await response.json();
        
        const container = document.getElementById('currentDocuments');
        
        if (data.success && data.documents.length > 0) {
            let html = '<div class="documents-list">';
            
            data.documents.forEach(doc => {
                if (doc.exists) {
                    html += `
                        <div class="document-item">
                            ${doc.extension === '.pdf' ? 
                                `<div style="width: 60px; height: 60px; background: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                                    <span style="font-size: 20px;">üìÑ</span>
                                </div>` :
                                `<img src="${doc.url}" alt="${doc.filename}" onerror="this.style.display='none'">`
                            }
                            <div class="document-info">
                                <strong>${doc.filename}</strong><br>
                                <small>K√≠ch th∆∞·ªõc: ${(doc.size / 1024).toFixed(1)} KB</small>
                            </div>
                            <div class="document-actions">
                                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">Xem</a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteDocument(${vehicleId}, '${doc.filename}')">X√≥a</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ s·ªï ƒëƒÉng ki·ªÉm n√†o</p>';
        }
    } catch (error) {
        console.error('L·ªói khi t·∫£i s·ªï ƒëƒÉng ki·ªÉm:', error);
        document.getElementById('currentDocuments').innerHTML = '<p style="color: #e74c3c;">L·ªói khi t·∫£i s·ªï ƒëƒÉng ki·ªÉm</p>';
    }
}

async function loadCurrentPhuHieuDocuments(vehicleId) {
    try {
        const response = await fetch(`/vehicles/phu-hieu-documents/${vehicleId}`);
        const data = await response.json();
        
        const container = document.getElementById('currentPhuHieuDocuments');
        
        if (data.success && data.documents.length > 0) {
            let html = '<div class="documents-list">';
            
            data.documents.forEach(doc => {
                if (doc.exists) {
                    html += `
                        <div class="document-item">
                            ${doc.extension === '.pdf' ? 
                                `<div style="width: 60px; height: 60px; background: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                                    <span style="font-size: 20px;">üìÑ</span>
                                </div>` :
                                `<img src="${doc.url}" alt="${doc.filename}" onerror="this.style.display='none'">`
                            }
                            <div class="document-info">
                                <strong>${doc.filename}</strong><br>
                                <small>K√≠ch th∆∞·ªõc: ${(doc.size / 1024).toFixed(1)} KB</small>
                            </div>
                            <div class="document-actions">
                                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">Xem</a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deletePhuHieuDocument(${vehicleId}, '${doc.filename}')">X√≥a</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p style="color: #7f8c8d;">Ch∆∞a c√≥ ph√π hi·ªáu v·∫≠n t·∫£i n√†o</p>';
        }
    } catch (error) {
        console.error('L·ªói khi t·∫£i ph√π hi·ªáu v·∫≠n t·∫£i:', error);
        document.getElementById('currentPhuHieuDocuments').innerHTML = '<p style="color: #e74c3c;">L·ªói khi t·∫£i ph√π hi·ªáu v·∫≠n t·∫£i</p>';
    }
}

// X√≥a s·ªï ƒëƒÉng ki·ªÉm
async function deleteDocument(vehicleId, filename) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/vehicles/documents/${vehicleId}?filename=${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('X√≥a file th√†nh c√¥ng');
            // Reload danh s√°ch s·ªï ƒëƒÉng ki·ªÉm
            loadCurrentDocuments(vehicleId);
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói khi x√≥a file:', error);
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a file');
    }
}

// X√≥a ph√π hi·ªáu v·∫≠n t·∫£i
async function deletePhuHieuDocument(vehicleId, filename) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/vehicles/phu-hieu-documents/${vehicleId}?filename=${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('X√≥a file th√†nh c√¥ng');
            // Reload danh s√°ch ph√π hi·ªáu v·∫≠n t·∫£i
            loadCurrentPhuHieuDocuments(vehicleId);
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói khi x√≥a file:', error);
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a file');
    }
}
</script>
{% endblock %}
