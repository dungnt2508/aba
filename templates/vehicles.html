{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω xe - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>üöö Qu·∫£n l√Ω xe</h2>

<!-- Button th√™m m·ªõi xe -->
<div style="margin-bottom: 20px;">
    <button type="button" class="btn btn-success" onclick="openAddVehicleModal()">
        ‚ûï Th√™m m·ªõi xe
    </button>
</div>

<h3>üìã Danh s√°ch xe</h3>
{% if vehicles %}
<div style="overflow-x: auto;">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>Bi·ªÉn s·ªë xe</th>
                <th>Th√¥ng tin xe</th>
                <th>T·∫£i tr·ªçng</th>
                <th>ƒê·ªãnh m·ª©c nhi√™n li·ªáu</th>
                <th>Ng√†y h·∫øt h·∫°n ƒëƒÉng ki·ªÉm</th>
                <th>S·ªï ƒëƒÉng ki·ªÉm</th>
                <th>Ng√†y h·∫øt h·∫°n ph√π hi·ªáu</th>
                <th>Ph√π hi·ªáu v·∫≠n t·∫£i</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody>
            {% for vehicle in vehicles %}
            <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ vehicle.license_plate }}</strong></td>
                <td>{{ vehicle.vehicle_info or 'Ch∆∞a c·∫≠p nh·∫≠t' }}</td>
                <td>{{ "{:,.0f}".format(vehicle.capacity) if vehicle.capacity else '0' }} kg</td>
                <td>{{ vehicle.fuel_consumption or '0' }} l/100km</td>
                <td>
                    {% if vehicle.inspection_expiry %}
                        {% set days_until_expiry = (vehicle.inspection_expiry - today).days %}
                        {% if days_until_expiry < 0 %}
                            <span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è H·∫øt h·∫°n</span>
                        {% elif days_until_expiry <= 30 %}
                            <span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è {{ vehicle.inspection_expiry.strftime('%d/%m/%Y') }}</span>
                        {% else %}
                            {{ vehicle.inspection_expiry.strftime('%d/%m/%Y') }}
                        {% endif %}
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c·∫≠p nh·∫≠t</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.inspection_documents %}
                        <button type="button" class="btn btn-sm btn-info" onclick="viewInspectionDocuments({{ vehicle.id }})">
                            üëÅÔ∏è Xem
                        </button>
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.phu_hieu_expired_date %}
                        {% set days_until_expiry = (vehicle.phu_hieu_expired_date - today).days %}
                        {% if days_until_expiry < 0 %}
                            <span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è H·∫øt h·∫°n</span>
                        {% elif days_until_expiry <= 30 %}
                            <span style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è {{ vehicle.phu_hieu_expired_date.strftime('%d/%m/%Y') }}</span>
                        {% else %}
                            {{ vehicle.phu_hieu_expired_date.strftime('%d/%m/%Y') }}
                        {% endif %}
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c·∫≠p nh·∫≠t</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.phu_hieu_files %}
                        <button type="button" class="btn btn-sm btn-info" onclick="viewPhuHieuDocuments({{ vehicle.id }})">
                            üëÅÔ∏è Xem
                        </button>
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥</span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <a href="/vehicles/edit/{{ vehicle.id }}" class="btn btn-sm btn-primary" style="padding: 5px 10px; font-size: 12px;">S·ª≠a</a>
                        <form method="post" action="/vehicles/delete/{{ vehicle.id }}" style="display: inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a xe n√†y?')">
                            <button type="submit" class="btn btn-sm btn-danger" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üöö Ch∆∞a c√≥ xe n√†o</h3>
    <p>H√£y th√™m xe ƒë·∫ßu ti√™n b·∫±ng n√∫t "Th√™m m·ªõi xe" b√™n tr√™n</p>
</div>
{% endif %}

<!-- Modal th√™m xe m·ªõi -->
<div id="addVehicleModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>‚ûï Th√™m xe m·ªõi</h3>
            <span class="close" onclick="closeAddVehicleModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addVehicleForm" method="post" action="/vehicles/add" enctype="multipart/form-data">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="license_plate">Bi·ªÉn s·ªë xe *</label>
                        <input type="text" id="license_plate" name="license_plate" required placeholder="VD: 50H-448.42">
                    </div>
                    <div class="form-group">
                        <label for="vehicle_info">Th√¥ng tin xe *</label>
                        <input type="text" id="vehicle_info" name="vehicle_info" required placeholder="VD: Hino 3T">
                    </div>
                    <div class="form-group">
                        <label for="capacity">T·∫£i tr·ªçng (kg) *</label>
                        <input type="number" id="capacity" name="capacity" step="100" required placeholder="VD: 5000">
                    </div>
                    <div class="form-group">
                        <label for="fuel_consumption">ƒê·ªãnh m·ª©c nhi√™n li·ªáu (l/100km)</label>
                        <input type="number" id="fuel_consumption" name="fuel_consumption" step="0.1" placeholder="VD: 25.5">
                    </div>
                    <div class="form-group">
                        <label for="inspection_expiry">Ng√†y h·∫øt h·∫°n ƒëƒÉng ki·ªÉm</label>
                        <input type="date" id="inspection_expiry" name="inspection_expiry">
                    </div>
                    <div class="form-group">
                        <label for="inspection_documents">Upload s·ªï ƒëƒÉng ki·ªÉm</label>
                        <input type="file" id="inspection_documents" name="inspection_documents" multiple accept=".pdf,.jpg,.jpeg,.png,.gif">
                        <small style="color: #7f8c8d;">C√≥ th·ªÉ ch·ªçn nhi·ªÅu ·∫£nh (PDF, JPG, PNG, GIF)</small>
                    </div>
                    <div class="form-group">
                        <label for="phu_hieu_expired_date">Ng√†y h·∫øt h·∫°n ph√π hi·ªáu v·∫≠n t·∫£i</label>
                        <input type="date" id="phu_hieu_expired_date" name="phu_hieu_expired_date">
                    </div>
                    <div class="form-group">
                        <label for="phu_hieu_files">Upload h√¨nh ·∫£nh ph√π hi·ªáu v·∫≠n t·∫£i</label>
                        <input type="file" id="phu_hieu_files" name="phu_hieu_files" multiple accept=".pdf,.jpg,.jpeg,.png,.gif">
                        <small style="color: #7f8c8d;">C√≥ th·ªÉ ch·ªçn nhi·ªÅu ·∫£nh (PDF, JPG, PNG, GIF)</small>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <div id="imagePreview" style="display: none; margin-top: 10px;">
                        <h4>Xem tr∆∞·ªõc ·∫£nh:</h4>
                        <div id="previewContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                    </div>
                </div>
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddVehicleModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal xem s·ªï ƒëƒÉng ki·ªÉm -->
<div id="inspectionModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>üìÑ S·ªï ƒëƒÉng ki·ªÉm</h3>
            <span class="close" onclick="closeInspectionModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="inspectionContent">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Modal xem ph√π hi·ªáu v·∫≠n t·∫£i -->
<div id="phuHieuModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>üöõ Ph√π hi·ªáu v·∫≠n t·∫£i</h3>
            <span class="close" onclick="closePhuHieuModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="phuHieuContent">
                <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
            </div>
        </div>
    </div>
</div>

<div style="margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° L∆∞u √Ω:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li>Bi·ªÉn s·ªë xe ph·∫£i l√† duy nh·∫•t trong h·ªá th·ªëng</li>
        <li>Th√¥ng tin xe v√† t·∫£i tr·ªçng l√† b·∫Øt bu·ªôc</li>
        <li>Ng√†y h·∫øt h·∫°n ƒëƒÉng ki·ªÉm s·∫Ω hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu s·∫Øp h·∫øt h·∫°n (d∆∞·ªõi 30 ng√†y)</li>
        <li>C√≥ th·ªÉ upload nhi·ªÅu ·∫£nh s·ªï ƒëƒÉng ki·ªÉm</li>
    </ul>
</div>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 10px 10px 0 0;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    background: #f8f9fa;
    border-radius: 0 0 10px 10px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.preview-image {
    max-width: 100px;
    max-height: 100px;
    object-fit: cover;
    border-radius: 5px;
    border: 2px solid #ddd;
}

.document-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 10px;
}

.document-item img {
    max-width: 80px;
    max-height: 80px;
    object-fit: cover;
    border-radius: 5px;
}

.document-info {
    flex: 1;
}

.document-actions {
    display: flex;
    gap: 5px;
}
</style>

<script>
function openAddVehicleModal() {
    document.getElementById('addVehicleModal').style.display = 'block';
}

function closeAddVehicleModal() {
    document.getElementById('addVehicleModal').style.display = 'none';
    document.getElementById('addVehicleForm').reset();
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('previewContainer').innerHTML = '';
}

function openInspectionModal() {
    document.getElementById('inspectionModal').style.display = 'block';
}

function closeInspectionModal() {
    document.getElementById('inspectionModal').style.display = 'none';
    document.getElementById('inspectionContent').innerHTML = '';
}

function openPhuHieuModal() {
    document.getElementById('phuHieuModal').style.display = 'block';
}

function closePhuHieuModal() {
    document.getElementById('phuHieuModal').style.display = 'none';
    document.getElementById('phuHieuContent').innerHTML = '';
}

// Xem tr∆∞·ªõc ·∫£nh khi ch·ªçn file
document.getElementById('inspection_documents').addEventListener('change', function(e) {
    const files = e.target.files;
    const previewContainer = document.getElementById('previewContainer');
    const imagePreview = document.getElementById('imagePreview');
    
    previewContainer.innerHTML = '';
    
    if (files.length > 0) {
        imagePreview.style.display = 'block';
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-image';
                    img.title = file.name;
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }
    } else {
        imagePreview.style.display = 'none';
    }
});

// Xem s·ªï ƒëƒÉng ki·ªÉm
async function viewInspectionDocuments(vehicleId) {
    try {
        const response = await fetch(`/vehicles/documents/${vehicleId}`);
        const data = await response.json();
        
        const content = document.getElementById('inspectionContent');
        
        if (data.success && data.documents.length > 0) {
            let html = '<div class="documents-list">';
            
            data.documents.forEach(doc => {
                if (doc.exists) {
                    html += `
                        <div class="document-item">
                            ${doc.extension === '.pdf' ? 
                                `<div style="width: 80px; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                                    <span style="font-size: 24px;">üìÑ</span>
                                </div>` :
                                `<img src="${doc.url}" alt="${doc.filename}" onerror="this.style.display='none'">`
                            }
                            <div class="document-info">
                                <strong>${doc.filename}</strong><br>
                                <small>K√≠ch th∆∞·ªõc: ${(doc.size / 1024).toFixed(1)} KB</small>
                            </div>
                            <div class="document-actions">
                                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">Xem</a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteDocument(${vehicleId}, '${doc.filename}')">X√≥a</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Ch∆∞a c√≥ s·ªï ƒëƒÉng ki·ªÉm n√†o</p>';
        }
        
        openInspectionModal();
    } catch (error) {
        console.error('L·ªói khi t·∫£i s·ªï ƒëƒÉng ki·ªÉm:', error);
        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i s·ªï ƒëƒÉng ki·ªÉm');
    }
}

// Xem ph√π hi·ªáu v·∫≠n t·∫£i
async function viewPhuHieuDocuments(vehicleId) {
    try {
        const response = await fetch(`/vehicles/phu-hieu-documents/${vehicleId}`);
        const data = await response.json();
        
        const content = document.getElementById('phuHieuContent');
        
        if (data.success && data.documents.length > 0) {
            let html = '<div class="documents-list">';
            
            data.documents.forEach(doc => {
                if (doc.exists) {
                    html += `
                        <div class="document-item">
                            ${doc.extension === '.pdf' ? 
                                `<div style="width: 80px; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 5px;">
                                    <span style="font-size: 24px;">üìÑ</span>
                                </div>` :
                                `<img src="${doc.url}" alt="${doc.filename}" onerror="this.style.display='none'">`
                            }
                            <div class="document-info">
                                <strong>${doc.filename}</strong><br>
                                <small>K√≠ch th∆∞·ªõc: ${(doc.size / 1024).toFixed(1)} KB</small>
                            </div>
                            <div class="document-actions">
                                <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">Xem</a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deletePhuHieuDocument(${vehicleId}, '${doc.filename}')">X√≥a</button>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            content.innerHTML = html;
        } else {
            content.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Ch∆∞a c√≥ ph√π hi·ªáu v·∫≠n t·∫£i n√†o</p>';
        }
        
        openPhuHieuModal();
    } catch (error) {
        console.error('L·ªói khi t·∫£i ph√π hi·ªáu v·∫≠n t·∫£i:', error);
        alert('C√≥ l·ªói x·∫£y ra khi t·∫£i ph√π hi·ªáu v·∫≠n t·∫£i');
    }
}

// X√≥a s·ªï ƒëƒÉng ki·ªÉm
async function deleteDocument(vehicleId, filename) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/vehicles/documents/${vehicleId}?filename=${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('X√≥a file th√†nh c√¥ng');
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói khi x√≥a file:', error);
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a file');
    }
}

// X√≥a ph√π hi·ªáu v·∫≠n t·∫£i
async function deletePhuHieuDocument(vehicleId, filename) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a file n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/vehicles/phu-hieu-documents/${vehicleId}?filename=${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('X√≥a file th√†nh c√¥ng');
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        console.error('L·ªói khi x√≥a file:', error);
        alert('C√≥ l·ªói x·∫£y ra khi x√≥a file');
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const addModal = document.getElementById('addVehicleModal');
    const inspectionModal = document.getElementById('inspectionModal');
    const phuHieuModal = document.getElementById('phuHieuModal');
    
    if (event.target === addModal) {
        closeAddVehicleModal();
    }
    if (event.target === inspectionModal) {
        closeInspectionModal();
    }
    if (event.target === phuHieuModal) {
        closePhuHieuModal();
    }
}
</script>
{% endblock %}
