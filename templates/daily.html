{% extends "base.html" %}

{% block title %}B·∫£ng ch·∫•m c√¥ng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>üìÖ Ng√†y ch·∫•m c√¥ng</h2>
<div style="margin-bottom: 30px;">
    <label for="selected_date" style="color: #7f8c8d; margin-right: 10px;">Ch·ªçn ng√†y:</label>
    <input type="date" id="selected_date" name="selected_date" value="{{ selected_date or today.strftime('%Y-%m-%d') }}" 
           style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; color: #7f8c8d;"
           onchange="filterByDate()">
    <!-- Debug: selected_date = {{ selected_date }}, today = {{ today.strftime('%Y-%m-%d') }}, filter_date = {{ filter_date.strftime('%Y-%m-%d') if filter_date else 'None' }} -->
</div>

<!-- Debug Info -->
<!-- <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-size: 12px;">
    <strong>Debug Info:</strong><br>
    - S·ªë tuy·∫øn: {{ routes|length }}<br>
    - S·ªë nh√¢n vi√™n: {{ employees|length }}<br>
    - S·ªë xe: {{ vehicles|length }}<br>
    {% if vehicles|length > 0 %}
    - Danh s√°ch xe: {% for v in vehicles %}{{ v.license_plate }}{% if not loop.last %}, {% endif %}{% endfor %}<br>
    {% endif %}
</div> -->

<div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #f39c12; margin-bottom: 15px;">üìù B·∫£ng ch·∫•m c√¥ng</h3>
    
    <form method="post" action="/daily/add" id="dailyForm">
        <input type="hidden" name="date" value="{{ selected_date or today.strftime('%Y-%m-%d') }}">
        
        <table class="table" style="background: white; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>M√£ tuy·∫øn</th>
                    <th>Kho·∫£ng c√°ch (km)</th>
                    <th>S·ªë km th·ª±c t·∫ø</th>
                    <th>T√™n l√°i xe</th>
                    <th>Bi·ªÉn s·ªë xe</th>
                    <th>Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody>
                {% for route in routes %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ route.route_code }}</strong></td>
                    <td>{{ route.distance or 'N/A' }}</td>
                    <td>
                        <input type="number" 
                               name="distance_km_{{ route.id }}" 
                               step="0.1" 
                               placeholder="0.0" 
                               style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                    <td>
                        <select name="driver_name_{{ route.id }}" style="width: 120px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">Ch·ªçn l√°i xe</option>
                            {% for employee in employees %}
                            <option value="{{ employee.name }}">{{ employee.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <select name="license_plate_{{ route.id }}" style="width: 120px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="">Ch·ªçn xe</option>
                            <!-- Debug: Total vehicles = {{ vehicles|length }} -->
                            {% for vehicle in vehicles %}
                            <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                            {% endfor %}
                            {% if vehicles|length == 0 %}
                            <option value="" disabled>Kh√¥ng c√≥ xe</option>
                            {% endif %}
                        </select>
                    </td>
                    <td>
                        <input type="text" 
                               name="notes_{{ route.id }}" 
                               placeholder="Ghi ch√∫" 
                               style="width: 120px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ L∆∞u b·∫£ng ch·∫•m c√¥ng
            </button>
        </div>
    </form>
</div>

<h3>üìã Chuy·∫øn ƒë√£ ghi nh·∫≠n</h3>
{% if daily_routes %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ ghi nh·∫≠n {{ daily_routes|length }} chuy·∫øn
    </p>
</div>

<table class="table">
    <thead>
        <tr>
            <th>STT</th>
            <th>M√£ tuy·∫øn</th>
            <th>Ng√†y ch·∫°y</th>
            <th>S·ªë km</th>
            <th>L√°i xe</th>
            <th>Bi·ªÉn s·ªë xe</th>
            <th>Ghi ch√∫</th>
            <th>Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
        {% for daily_route in daily_routes %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ daily_route.route.route_code }}</strong></td>
            <td>{{ daily_route.date.strftime('%d/%m/%Y') }}</td>
            <td>{{ daily_route.distance_km }} km</td>
            <td>{{ daily_route.driver_name }}</td>
            <td>{{ daily_route.license_plate }}</td>
            <td>{{ daily_route.notes or 'Kh√¥ng c√≥' }}</td>
            <td>
                <button onclick="deleteRoute({{ daily_route.id }})" class="btn btn-sm btn-danger" style="padding: 3px 8px; font-size: 11px;">
                    X√≥a
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div style="margin-top: 20px; padding: 20px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
    <h4 style="color: #27ae60; margin-bottom: 10px;">üìä T·ªïng k·∫øt:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <strong>S·ªë chuy·∫øn:</strong> {{ daily_routes|length }}
        </div>
        <div>
            <strong>T·ªïng s·ªë km:</strong> {{ "{:,.1f}".format(daily_routes|sum(attribute='distance_km')) }} km
        </div>
        <div>
            <strong>S·ªë l√°i xe:</strong> {{ daily_routes|map(attribute='driver_name')|unique|list|length }}
        </div>
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üìÖ Ch∆∞a c√≥ chuy·∫øn n√†o</h3>
    <p>H√£y ghi nh·∫≠n chuy·∫øn ƒë·∫ßu ti√™n b·∫±ng form b√™n tr√™n</p>
</div>
{% endif %}

<div style="margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li><strong>S·ªë km:</strong> Qu√£ng ƒë∆∞·ªùng th·ª±c t·∫ø ƒë√£ ch·∫°y trong chuy·∫øn</li>
        <li><strong>T√™n l√°i xe:</strong> Ch·ªçn nh√¢n vi√™n th·ª±c hi·ªán l√°i xe trong chuy·∫øn</li>
        <li><strong>Bi·ªÉn s·ªë xe:</strong> Ch·ªçn xe t·ª´ danh s√°ch xe c√≥ s·∫µn trong h·ªá th·ªëng</li>
        <li><strong>Ghi ch√∫:</strong> Th√¥ng tin b·ªï sung nh∆∞ s·ª± c·ªë, thay ƒë·ªïi, etc.</li>
    </ul>
</div>

{% if not routes %}
<div style="margin-top: 20px; padding: 20px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o:</h4>
    <p style="color: #2c3e50;">C·∫ßn t·∫°o tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc khi ghi nh·∫≠n chuy·∫øn. <a href="/routes" style="color: #3498db;">T·∫°o tuy·∫øn ngay</a></p>
</div>
{% endif %}

<script>
function deleteRoute(routeId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy·∫øn n√†y?')) {
        // T·∫°o form ƒë·ªÉ submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/daily/delete/' + routeId;
        document.body.appendChild(form);
        form.submit();
    }
}

// L·ªçc d·ªØ li·ªáu theo ng√†y ƒë∆∞·ª£c ch·ªçn
function filterByDate() {
    const selectedDate = document.getElementById('selected_date').value;
    console.log('filterByDate called, selectedDate:', selectedDate); // Debug log
    console.log('Current URL:', window.location.href); // Debug log
    if (selectedDate) {
        const newUrl = `/daily?selected_date=${selectedDate}`;
        console.log('Redirecting to:', newUrl); // Debug log
        // Reload trang v·ªõi tham s·ªë ng√†y ƒë∆∞·ª£c ch·ªçn
        window.location.href = newUrl;
    } else {
        console.log('No date selected, not redirecting'); // Debug log
    }
}

// Kh√¥ng c·∫ßn auto-fill v√¨ template ƒë√£ set gi√° tr·ªã ƒë√∫ng
// document.addEventListener('DOMContentLoaded', function() {
//     // Template ƒë√£ set value ƒë√∫ng, kh√¥ng c·∫ßn JavaScript can thi·ªáp
// });
</script>
{% endblock %}
